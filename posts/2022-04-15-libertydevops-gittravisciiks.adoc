---
layout: post
title: "Continuous integration and delivery (CI/CD) of Jakarta EE & MicroProfile applications with Open Liberty to OpenShift using Travis CI"
categories: blog
author_picture: https://avatars3.githubusercontent.com/shamjithantholi
author_github: https://github.com/shamjithantholi
seo-title: TITLE - OpenLiberty.io
seo-description: DESCRIPTION
blog_description: "A high level explanation about how to build a devops pipeline with Travis CI. "
open-graph-image: https://openliberty.io/img/twitter_card.jpg
---
= Continuous integration and delivery (CI/CD) of Jakarta EE & MicroProfile applications with Open Liberty to OpenShift using Travis CI
Shamjith Antholi https://github.com/shamjithantholi
:imagesdir: /
:url-prefix:
:url-about: /

[#Intro]
== DevOps, CI/CD, Travis CI, OpenShift & OpenLiberty
DevOps is a culture or a process, which enables the integration of the software development (dev) and IT operations (ops). It can facilitate the setup of deployment pipeline and helps to improve the speed of software delivery. Automation of the entire build, test, and deployment of the software applications can be achieved through DevOps process. There are tons of efficient applications and process methodologies available in the market that can be readily integrated to the DevOps pipeline, which can help to achieve the wanted results.

CI/CD are acronym’s for continuous integration, and continuous delivery or deployment used in DevOps. Continuous integration is a process where developers frequently merge code changes into a source code repository, which automatically start code build, security scan, and test execution and deployment. Automation of this process enables organizations to release on a more frequent basis without compromising on quality. There are various tools available to automate the CI/CD process. In this blog post we'll discuss how you can use Travis CI to automate the CI/CD process for building, testing, and deploying your Open Liberty Java applications 

Travis CI is a contienous integration service use to build and test the code. Travis CI works with various Git flavors ( eg: GitHub, Bitbucket).

link:https://www.redhat.com/en/technologies/cloud-computing/openshift[OpenShift] is a containerization platform from RedHat. Contiainer orchastration in OpenShift are managed by Kubernetes and its build around linux containers.

Open Liberty is a lightweight Java runtime for building cloud-native applications and microservices. In this blog, it details how you can use Jenkins in CI/CD pipeline for Java based Openliberty application build/test/deployment Openliberty link:https://openliberty.io[OpenLiberty] .

The following diagram shows a simple architecture for a pipeline that builds and deploys an Open Liberty application in a single Kubernetes environment. When a code change is detected by Travis CI, Travis builds the code, runs security and static analysis scans, and runs unit tests against the built code. Travis CI then generates a Docker image of the application with its Open Liberty server and saves the image to a Docker repository, Travis then trigger the deployment using CLI commands and deploy the Docker image to OpenShift.

image::/img/blog/liberty-devops-generic-architecture-travis-ocp.png[Liberty devops generic architecture diagram ,width=70%,align="center"]

Basic understanding of git, Docker and containerization concepts are a prerequisite for this blog.

== Setting up Travis CI and OpenShift for CI/CD of Open Liberty applications ==

Provision *Travis CI* from link:https://www.travis-ci.com/?_gl=1%2A1tiil9q%2A_ga%2AMTIwMjg2NTQ2NS4xNjUwNTUwODU5%2A_ga_XRYGSZFQ0P%2AMTY1MDkwOTQwMC40LjAuMTY1MDkwOTQwOC41Mg..[Travis CI] and integrate your GitHub repository with it (when your personal profile or repository is integrated with travis CI, presense of a *.travis.yml* file in the repository will be enough for syncing that repository with travis CI). 

     --> Go to "https://app.travis-ci.com/signin" and Sign up with GitHub.
     --> Accept the Authorization of Travis CI. You’ll be redirected to GitHub.

image::/img/blog/travisci-homepage.png[Travis CI - Github integration ,width=50%,align="center"]

image::/img/blog/travis-integrated-gitrepo.png[Travis CI - Github integration ,width=50%,align="center"]

     --> Activate the required project as shown in the above screenshot

Provision the OpenShift cluster on IBM cloud (https://cloud.ibm.com), generate OpenShift token for CLI connectivity, verify the basic k8s cluster login commands (please note: For working with the steps explained in this blog, you can use any other kubernetes service of your choice ).     

The next step is to complete the openshift platform setup to make it ready for application deployment. After installing/provisioning a managed OpenShift, login to it using username and password and get the authentication token which is going to be used in Travis CI for connectivity

Create a new project/namespace. Create OpenShift secrets to checkout the code from GitHub to OpenShift (upload the public to github ) and another one for accessing dockerhub repository from OpenShift
     
        oc create secret generic ssh-git \
              --from-file=ssh-privatekey=/Users/<username>/.ssh/id_rsa \
              --type=kubernetes.io/ssh-auth   

        oc create secret docker-registry regcred \
            --docker-server=https://index.docker.io/v1/ \
            --docker-username= <username> \
            --docker-password=<password> \
            --docker-email=<email-id>

Create a new application on OpenShift

        oc new-app git@github.ibm.com:shamjith-antholi/traviscidemo.git --source-secret=<ssh-git>

This command will create the build, deployment and service on OpenShift automatically. Verify that if the deployment is done successfully by login to OpenShift UI. Create a route on OpenShift and verify if the endpoints are reachable.

When deployment is successfull to local image stream, edit the OpenShift BuildConfig and DeploymentConfig to use the DockerHub repository for storing and pulling images.

*DeploymentConfig UI view*

image::/img/blog/deployment-config-ui-view.png[OpenShift - DeploymentConfig UI view ,width=50%,align="center"]

*BuildConfig YAML view*

image::/img/blog/buildconfig-yaml-view.png[OpenShift - BuildConfig YAML view ,width=50%,align="center"]

== Automating application deployment on OpenShift using Travis CI

As explained earlier, *.travis.yml* file must be available on the base path of the GitHub repository. An example view of Github repository base path is given below

image::/img/blog/gitrepo-base-path.png[Git repo base path,width=50%,align="center"]

Setup the required environment variables on Travis CI settings page

image::/img/blog/travis-env-setup.png[Travis CI environment variables,width=60%,align="center"]

Travis CI and OpenShift provides wide variety of build/deployment options, below given is a workable sample travis ci code and Dockerfile which is good enough to automate the code build

     language: java
     jdk:
       - openjdk8
     services:
       - docker  #enable internal docker service in travis ci
     before_install: 
       - oc login --token=$OCP_TOKEN --server=$OCP_SERVER --insecure-skip-tls-verify=true #ocp login command
     script:
       - mvn package #maven build command #with sonarqube scan command: mvn package verify sonar:sonar -Dsonar.projectKey=sampleapp -Dsonar.host.url=http://localhost:9000 -Dsonar.login=7b13f240d8dff455efdfbff07ba0479b13d09ba8
       - docker login -u $dockerhub_login -p $dockerhub_password  #login to dockerhub
       - docker build -t $dockerhub_login/sampleapp:v1.0 --build-arg package=target/sampleapp.war . #docker build and pass the deployment package to Dockerfile 
       - docker push $dockerhub_login/sampleapp:v1.0  #push docker image too dockerhub
       - docker run aquasec/trivy image --exit-code 1 --severity CRITICAL $docker_login/travisapp:v2.0  #with sonarqube scan command: mvn package verify sonar:sonar -Dsonar.projectKey=sampleapp -Dsonar.host.url=http://localhost:9000 -Dsonar.login=7b13f240d8dff455efdfbff07ba0479b13d09ba8
       - oc project demoproject #set the openshift project
       - oc scale deployment/sampleapp --replicas 0 #scale the existing openshift to zero
       - oc scale deployment/sampleapp --replicas 1 #scale the existing openshift to one (or more)
     after_success:
       - echo "success"

Following are the execution steps in the above given travis ci code

* Maven build and packaging (if configured, will do the junit test execution and static code analysis with SonarQube) 
* Build the Dockerfile and generate the docker image
* Store the docker image in docker hub repository
* Run the docker image scan using aqua trivy
* Restart the OpenShift deployment by down scaling and up scaling (This works if the docker image generated here and the image version configured in the openshift deployment config are the same, otherwise you can programmatically change the image name/version from travis CI confiruration itself. Please note that this is only one way of doing the deployment) 

  Sample code to do the dynamic image name/version change from CLI (this can be used in Travis CI code): 
  oc patch deployment/sampleapp --type='json' -p='[{"op": "replace", "path": "/spec/template/spec/containers/0/image", "value":"<dockerhubid>/sampleapp:v2.0"}]'


The standard Dockerfile that you use in general is not enough to do the Liberty application deployment on containerized environment. A sample Openliberty compliant Dockerfile snipped in given, you can configure it as needed.

  FROM icr.io/appcafe/open-liberty:kernel-slim-java8-openj9-ubi
  USER root 
  # deployment package recieved from travis CI
  ARG package
  COPY $package /config/dropins/
  # Add Liberty server configuration including all necessary features
  COPY --chown=1001:0  server.xml /config/
  # Modify feature repository (optional)
  # A sample is in the 'Getting Required Features' section below
  COPY --chown=1001:0 featureUtility.properties /opt/ol/wlp/etc/
  # This script will add the requested XML snippets to enable Liberty features and grow image to be fit-for-purpose using featureUtility. 
  # Only available in 'kernel-slim'. The 'full' tag already includes all features for convenience.
  RUN features.sh
  # Add interim fixes (optional)
  #COPY --chown=1001:0  interim-fixes /opt/ol/fixes/
  .
  .
  .
  .
  RUN chmod 755 /config/dropins/$package
  RUN chown 1001:0 /config/dropins/$package
  WORKDIR /
  # This script will add the requested server configurations, apply any interim fixes and populate caches to optimize runtime
  RUN configure.sh

For SonarQube server setup, we can use SonarQube community edition. Install sonarqube server by either using file startup type from cli downloading the package in link:https://www.sonarqube.org/success-download-community-edition/[SonarQube server install package] or use docker way as explained in link:https://docs.sonarqube.org/latest/setup/get-started-2-minutes/[Sonarqube server install steps]. 

Any code commit in GitHub repository will start the travis CI build and OpenShift deployment will be done autoimatically as explained above.  

== Conclusion
There are many ways in which you can configure your DevOps pipeline. This blog post is a quick introduction to how you can use Travis CI and OpenShift to set up a simple CI/CD pipeline to build and deploy your Liberty Java applications.
