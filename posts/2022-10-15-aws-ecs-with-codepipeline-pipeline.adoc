---
layout: post
title: "DevOps pipeline for deploying OpenLiberty applications into AWS Elastic container service"
categories: blog
author_picture: https://avatars3.githubusercontent.com/shamjithantholi
author_github: https://github.com/shamjithantholi
seo-title: DevOps pipeline for deploying OpenLiberty applications into AWS Elastic container service
seo-description: Steps to develop DevOps pipeline on AWS platform for deploying OpenLiberty applications using AWS codepipeline, AWS codecommit, AWS codebuild and AWS Elastic container service.
blog_description: Steps to develop DevOps pipeline on AWS platform for deploying OpenLiberty applications using AWS codepipeline, AWS codecommit, AWS codebuild and AWS Elastic container service.
open-graph-image: https://openliberty.io/img/blog/aws-ecs-devops-devops-generic-architecture.png
---
= DevOps pipeline for deploying OpenLiberty applications into AWS Elastic container service
Shamjith Antholi <https://github.com/shamjithantholi>
:imagesdir: /
:url-prefix:
:url-about: /

[#Intro]

## AWS devops introduction

This blog contains the steps to build DevOps pipeline on AWS platform 

== Setting AWS networking components for Elastic container services(ECS)

=== VPC

Create a new VPC with custom CIDR whose IP range will be used to host all the associated components of this pipeline.

Login to link:http://aws.amazon.com[AWS] and search for VPC and enter the details as given below

image::/img/blog/create-vpc.png[Create VPC,width=80%,align="left"]

Edit the "DNS hostnames" of this new VPC and enable it

image::/img/blog/edit-dns-hostnames.png[Edit DNS hostnames,width=80%,align="left"]

Edit the "DNS resolution" of this new VPC and enable it

image::/img/blog/edit-dns-resolutions.png[Edit DNS resolutions,width=80%,align="left"]

=== Subnets and Internet Gateway

We need to create a private subnet within the VPC to define the hosted applications access to internal (private). Internet gateways are created and configured to route the traffic to load balancer 

=== Route table

Login to link:http://aws.amazon.com[AWS]  and go to VPC --> Route tables and create a new route table

image::/img/blog/create-route-table.png[Create Route table,width=80%,align="left"]

=== Private subnet

Login to link:http://aws.amazon.com[AWS]  and go to VPC --> Subnets and create 2 private subnets which is hosted on 2  different availability zones

image::/img/blog/create-private-subnet1.png[Create private subnet,width=80%,align="left"]

image::/img/blog/create-private-subnet2.png[Create private subnet,width=80%,align="left"]

=== Internet Gateway

Login to link:http://aws.amazon.com[AWS]  and go to VPC --> Internet gateways and create a new Internet Gateway

image::/img/blog/create-internet-gateway.png[Create Internet gateway,width=80%,align="left"]

Select this new internet gateway and attached it to above created VPC

image::/img/blog/attach-igw-to-vpc.png[Attach internet gateway to VPC,width=80%,align="left"]

=== Configure Route tables

Login to link:http://aws.amazon.com[AWS] and Go to the route table created earlier and then go to "Subnet associations tab" and then click on "Edit subnet association"

image::/img/blog/route-table-config-2.png[Route table configuration - subnet association ,width=80%,align="left"]

Select the 2 private subnets selected and click on save 

image::/img/blog/route-table-config-5.png[Route table configuration - subnet association ,width=80%,align="left"]

Login to link:http://aws.amazon.com[AWS] and Go to the route table created earlier and then go to "Routes tab"

image::/img/blog/route-table-config-1.png[Route table configuration,width=80%,align="left"]

Click on "Edit route" and then on "Add route" and select earlier created internet gateway as the target (select 0.0.0.0/0 as destination IP)

image::/img/blog/route-table-config-4.png[Route table configuration,width=80%,align="left"]

=== Endpoints

Create ECR DKR endpoint

image::/img/blog/endpoint-ecr-dkr3.png[ECR DKR endpoint,width=80%,align="left"]

image::/img/blog/endpoint-ecr-dkr4.png[ECR DKR endpoint,width=80%,align="left"]

Create ECR API endpoint

image::/img/blog/endpoint-ecr-api1.png[ECR API endpoint,width=80%,align="left"]

image::/img/blog/endpoint-ecr-api2.png[ECR API endpoint,width=80%,align="left"]

Create S3 endpoint (gateway)

image::/img/blog/openliberty-ep-s3-1.png[ECR S3 endpoint,width=80%,align="left"]

image::/img/blog/openliberty-ep-s3-2.png[ECR S3 endpoint,width=80%,align="left"]

Create LOGS endpoint

image::/img/blog/openliberty-ep-logs-1.png[ECR S3 endpoint,width=80%,align="left"]

image::/img/blog/openliberty-ep-logs-2.png[ECR S3 endpoint,width=80%,align="left"]

== Create load balancer and target group

Login to link:http://aws.amazon.com[AWS] and search and for 'load balancer' 

Select 'Application Load Balancer' from load balancer types

image::/img/blog/loadbalancer-1.png[Creating load balancer,width=80%,align="left"]

Select the VPC created earlier and select the 2 availability zones in which out earlier created private subnet's are hosted

image::/img/blog/loadbalancer-2.png[Creating load balancer,width=80%,align="left"]

Create a new target group

image::/img/blog/loadbalancer-3.png[Creating load balancer,width=80%,align="left"]

Choose the target type as 'IP Address' and select the above created VPC, keep the other default options 

image::/img/blog/loadbalancer-4.png[Creating target group,width=80%,align="left"]

Submit the form and wait for the load balancer status to be 'Active'

== ECS cluster and associated components 

=== ECS cluster
Login to link:http://aws.amazon.com[AWS] and search and for 'ECS' and select 'Elastic Container Service' 

Click on 'Create CLuster', and you will land in this page

image::/img/blog/create-ecs-cluster1.png[Creating ECS cluster,width=80%,align="left"]

Select "Network only" and 'Next step'

Provide a suitable name and click on 'Create', an ECS cluster will be created

image::/img/blog/create-ecs-cluster2.png[Creating ECS cluster,width=80%,align="left"]

=== Task Defenition

Login to link:http://aws.amazon.com[AWS] and search and for 'ECS' and select 'Elastic Container Service' 

Click on 'Task Defenitions' from the right column and 'Create new Task Defenition'

image::/img/blog/create-ecs-taskdefenition1.png[Creating ECS task defenition,width=80%,align="left"]

Select 'Fargate' and go to 'Next step'

image::/img/blog/create-ecs-taskdefenition2.png[Creating ECS task defenition,width=80%,align="left"]

image::/img/blog/create-ecs-taskdefenition3.png[Creating ECS task defenition,width=80%,align="left"]

image::/img/blog/create-ecs-taskdefenition4.png[Creating ECS task defenition,width=80%,align="left"]

Select the required memory and CPU and click on 'Add container'

Copy the image URL from ECR and copy the same to 'Image' box, provide the port in which deployed application would be accessible and click on 'Add'

image::/img/blog/create-ecs-taskdefenition5.png[Creating ECS task defenition,width=80%,align="left"]

After verifying everything, click on 'Create' to create an 'Active' task defenition

=== Create Service and Tasks

Login to link:http://aws.amazon.com[AWS] and search and for 'ECS' and select 'Elastic Container Service' 

Go to the cluster created above and go to 'Services' tab and click on 'Create'

image::/img/blog/create-ecs-service-1.png[Creating ECS service,width=80%,align="left"]

Enter the details as in this screenshot and go to 'Next step'

image::/img/blog/create-ecs-service-2.png[Creating ECS service,width=80%,align="left"]

image::/img/blog/create-ecs-service-3.png[Creating ECS service,width=80%,align="left"]

Select the above created VPC and the 2 private subnet's in the respective input boxes. Select 'Auto-assign public IP' to 'DISABLED'

image::/img/blog/create-ecs-service-4.png[Creating ECS service,width=80%,align="left"]

Note the default security group selected in this page, go to the 'Security Groups' page and create the InBound rule as given below

image::/img/blog/create-ecs-service-7.png[Creating ECS service,width=80%,align="left"]

Select 'Application Load balancer' from the 'Load balancing' section, select the appropriate load balancer from the 'Load balancer name' dropdown + 

image::/img/blog/create-ecs-service-5.png[Creating InBound rules,width=80%,align="left"]

Select the appropriate container from 'Container name : port' drop down and click on 'Add to load balancer' + 
Select '80:http' from 'Production listener port*' drop down and select target group created earlier and go to next step and click on 'Create Service'

image::/img/blog/create-ecs-service-6.png[Creating ECS service,width=80%,align="left"]

A new service and the associated task (In 'Tasks' tab) will be created

Access this application from the Load balancer DNS name.

== Setting up DevOps pipeline to deploy to ECS

=== AWS source code repository

Login to link:http://aws.amazon.com[AWS] and search for 'CodeCommit' and click on 'Create repository'. +
Create a repository and check-in the openliberty code to this repository +
The only environment related file you need to create in this repository is 'buildspec.yml' (or any custom name). A sample buildspec file is give below

            version: 0.2

            phases:
                pre_build:
                    commands:
                        - aws ecr get-login-password --region <aws-availabilty-zone> | docker login --username AWS --password-stdin <aws-acc-id>.dkr.ecr.<aws-availability-zone>.amazonaws.com # this is for authenticating the access to Amazon Elastic Container Registry (ECR)
                build:
                commands:
                    - mvn package
                post_build:
                commands:
                    - docker build -t <container-image>:<image-version> .  
                    - docker tag <container-image>:<image-version> <aws-acc-id>.dkr.ecr.<aws-availabilty-zone>.amazonaws.com/<container-image>:<image-version>
                    - docker push <aes-acc-id>.dkr.ecr.<aws-availabilty-zone>.amazonaws.com/<container-image>:<image-version>
                    - printf '[{"name":"<ECS-container-name>","imageUri":"<aws-acc-id>.dkr.ecr.<aws-availabity-zone>.amazonaws.com/<container-image>:<image-version>"}]' > imagedefenitions.json # This is required for the ECS to pull the container from ECR instead of default S3 location 
            artifacts:
                files:
                - imagedefenitions.json 

Docker container details mentioned in the above given code should be similar to the one created in ECS task defenition (sample location picture is pasted below)

image::/img/blog/ecs-pipeline-5.png[ECS task defenition image reference,width=80%,align="left"]

=== Create AWS code build project

image::/img/blog/ecs-pipeline-codebuild-1.png[ECS code build creation,width=80%,align="left"]

image::/img/blog/ecs-pipeline-codebuild-2.png[ECS code build creation,width=80%,align="left"]


=== Create AWS codepipeline project

image::/img/blog/ecs-pipeline-1.png[ECS code pipeline creation,width=80%,align="left"]

image::/img/blog/ecs-pipeline-2.png[ECS code pipeline creation - source code,width=80%,align="left"]

image::/img/blog/ecs-pipeline-3.png[ECS code pipeline creation - build stage,width=80%,align="left"]

image::/img/blog/ecs-pipeline-4.png[ECS code pipeline creation - deploy stage,width=80%,align="left"]

Setting requirement permissions to the ecs service role created in the code pipeline creation process

image::/img/blog/ecs-pipeline-iam-1.png[IAM permission settings for ECS pipeline,width=80%,align="left"]

image::/img/blog/ecs-pipeline-iam-2.png[IAM permission settings for ECS pipeline,width=80%,align="left"]

image::/img/blog/ecs-pipeline-iam-3.png[IAM permission settings for ECS pipeline,width=80%,align="left"]