---
layout: post
title: "MicroProfile Context Propagration 1.2 and a number of enhancements in Open Liberty 21.0.0.4"
# Do NOT change the categories section
categories: blog
author_picture: https://avatars3.githubusercontent.com/jakub-pomykala
author_github: https://github.com/jakub-pomykala
seo-title: MicroProfile Context Propagration 1.2 and a number of enhancements in Open Liberty 21.0.0.4 - OpenLiberty.io
seo-description: In 21.0.0.4, we now offer MicroProfile Context Propagration 1.2 and a number of enhancements (expandLocation property for AutoExpand, Ability to control whether thread dumps are collected when a hung request is detected in the Request Timing feature, Automatic Cleanup of Leaked Connections, Single Sign-On (SSO) LTPA and JWT support authentication filter and Single Sign-On (SSO) LTPA and JWT support authentication filter)
blog_description: In 21.0.0.4, we now offer MicroProfile Context Propagration 1.2 and a number of enhancements (expandLocation property for AutoExpand, Ability to control whether thread dumps are collected when a hung request is detected in the Request Timing feature, Automatic Cleanup of Leaked Connections, Single Sign-On (SSO) LTPA and JWT support authentication filter and Single Sign-On (SSO) LTPA and JWT support authentication filter)
open-graph-image: https://openliberty.io/img/twitter_card.jpg
---
= MicroProfile Context Propagration 1.2 and a number of enhancements in Open Liberty 21.0.0.4
Jakub Pomykala <https://github.com/jakub-pomykala>
:imagesdir: /
:url-prefix:
:url-about: /
//Blank line here is necessary before starting the body of the post.


// tag::intro[]

In 21.0.0.4, we now offer MicroProfile Context Propagration 1.2, which addresses the difference in how link:{url-prefix}/blog/2021/03/31/microprofile-config-2.0.html[MicroProfile Config 2.0] treats empty value configuration properties. Also in this release there is a number of enhancements which are: expandLocation property for AutoExpand, Ability to control whether thread dumps are collected when a hung request is detected in the Request Timing feature, Automatic Cleanup of Leaked Connections, Single Sign-On (SSO) LTPA and JWT support authentication filter and Single Sign-On (SSO) LTPA and JWT support authentication filter


In link:{url-about}[Open Liberty] 21.0.0.4:

* <<mpContextPropagation, MicroProfile Context Propagation 1.2>>
* <<expandLocation, expandLocation property for AutoExpand>>
* <<requestTiming, Ability to control whether thread dumps are collected when a hung request is detected in the Request Timing feature>>
* <<JDBC, Automatic Cleanup of Leaked Connections>>
* <<SSO, Single Sign-On (SSO) LTPA and JWT support authentication filter>>
* <<bugs, Notable bugs fixed in this release>>

View the list of fixed bugs in link:https://github.com/OpenLiberty/open-liberty/issues?q=label%3Arelease%3A21004+label%3A%22release+bug%22[21.0.0.4].
// end::intro[]


// tag::run[]
[#run]

== Run your apps using 21.0.0.4

If you're using link:{url-prefix}/guides/maven-intro.html[Maven], here are the coordinates:

[source,xml]
----
<dependency>
    <groupId>io.openliberty</groupId>
    <artifactId>openliberty-runtime</artifactId>
    <version>21.0.0.4</version>
    <type>zip</type>
</dependency>
----

Or for link:{url-prefix}/guides/gradle-intro.html[Gradle]:

[source,gradle]
----
dependencies {
    libertyRuntime group: 'io.openliberty', name: 'openliberty-runtime', version: '[21.0.0.4,)'
}
----

Or if you're using Docker:

[source]
----
FROM open-liberty
----
//end::run[]

Or take a look at our link:{url-prefix}/downloads/[Downloads page].

[link=https://stackoverflow.com/tags/open-liberty]
image::img/blog/blog_btn_stack.svg[Ask a question on Stack Overflow, align="center"]

//tag::features[]

[#mpContextPropagation]
== MicroProfile Context Propagation 1.2

MicroProfile Context Propagation is a standalone MicroProfile specification. MicroProfile Context Propagation enables you to create completion stages that behave deterministically with respect to thread context and leverages the autonomic tuning of the Liberty global thread pool for asynchronous dependent stages.

The 1.2 release of MicroProfile Context Propagation aligns with the MicroProfile 4.0 platform, specifically addressing a difference in how link:{url-prefix}/blog/2021/03/31/microprofile-config-2.0.html[MicroProfile Config 2.0] treats empty value configuration properties. When using MicroProfile Config to specify an empty list of thread context types for MicroProfile Context Propagation to use as defaults, use a value of `None` rather than an empty value. An empty value in MicroProfile Config 2.0 indicates to override any lower ordinal config sources and instead use the built-in default value for the property.  For example, the combination of `mp.context.ManagedExecutor.cleared=None` and `mp.context.ManagedExecutor.propagated=Remaining` causes every context type to be propagated.

To enable the MicroProfile Context Propagation 1.2 feature, add the following to your server configuration:
[source, xml]
----
<featureManager>
  <feature>mpContextPropagation-1.2</feature>
  <!-- other features used by example code... -->
  <feature>servlet-4.0</feature>
  <feature>jdbc-4.2</feature>
  <feature>jndi-1.0</feature>
</featureManager>
----

Example usage within a Servlet:
[source, java]
----
private ManagedExecutor executor;

public void init(ServletConfig config) throws ServletException {
    executor = ManagedExecutor.builder()
                .propagated(ThreadContext.APPLICATION)
                .cleared(ThreadContext.ALL_REMAINING)
                .build();
}

public void destroy() {
    executor.shutdownNow();
}

public void doGet(HttpServletRequest req, HttpServletResponse resp)
    throws ServletException, IOException {
    ...
    executor.copy(unmanagedCompletionStage).thenAcceptAsync(value -> {
        // requires java:comp namespace of the application,
        DataSource ds = InitialContext.doLookup("java:comp/env/jdbc/ds");
        ...
    });
}
----

For more information please see: 
* link:https://download.eclipse.org/microprofile/microprofile-context-propagation-1.2/microprofile-context-propagation-spec-1.2.html[MicroProfile Context Propagation 1.2 specification]
* link:https://download.eclipse.org/microprofile/microprofile-context-propagation-1.2/apidocs/[JavaDoc]

[#xpandLocation]
=== expandLocation property for AutoExpand

With this enhancement users are now able to specify a expansion location (`expandLocation`) on the `applicationManager` configuration to be utilized when the `autoExpand` attribute is set to "true". As currently implemented, when an application is autoExpanded the default location for the expanded files are hard coded to `${server.config.dir}/apps/expanded/`.

Now with this enhancement in place, the users are able to configure that location to a new value on the `filesystem`. Thus for example:

`<applicationManager autoExpand="true" expandLocation="${server.config.dir}/myApps/" />` would result in the application being expanded at `${server.config.dir}/myApps/{appname}/`.

This enhancement gives users more flexibility regarding the location of their expanded applications.

Find out more at link:{url-prefix}/docs/latest/reference/config/applicationManager.html[Open Liberty Application Manager Documentation]

[#requestTiming]
== Ability to control whether thread dumps are collected when a hung request is detected in the Request Timing feature

The Request Timing feature (`requestTiming-1.0`) provides diagnostic information when the duration of any request exceeds the configured threshold. It provides a way to monitor requests with respect to time. The feature can automatically detect slow and hung requests and provide detailed diagnostic information; warning messages, thread stacks, and the creation of thread dumps.

When a hung request is detected in the Request Timing feature, a warning message is written in the messages log file along with a dump of the events that happened during the request. Following that, a set of three thread dumps will be initiated, 1 minute apart. After the completion of the three thread dumps, further set of three thread dumps are created only if new requests are detected to be hanging.

Some operations teams do not want so many thread dumps to be generated due to performance overhead on requests that are known to be long. In previous Open Liberty releases, there was no option to disable the thread dumps from being generated.

You can now control whether the Request Timing feature collects thread dumps. By setting the **NEW** `enableThreadDumps` Request Timing server configuration attribute to false, thread dumps will not be created during hung requests. If the new server configuration attribute is set to true or not specified at all, thread dumps will still be created.
   
The new Request Timing server configuration attribute can be configured in your server.xml as follows:

[source, xml]
----
<requestTiming includeContextInfo="true" slowRequestThreshold="120s" hungRequestThreshold="10s" sampleRate="1" enableThreadDumps="false"></requestTiming>`
----


The `enableThreadDumps` server configuration attribute can also be used in embedded Request Timing sub-elements: 
`<servletTiming/>` or `<jdbcTiming/>`, as follows:

[source, xml]
----
<requestTiming includeContextInfo="true" slowRequestThreshold="120s" hungRequestThreshold="10s" sampleRate="1">
    <servletTiming appName="MyApp" servletName="MyServletApp" slowRequestThreshold="100s" hungRequestThreshold="5s" enableThreadDumps="false"/>
</requestTiming>`
----

NOTE: An embedded `<servletTiming/>` or `<jdbcTiming/>` configuration in the server.xml file overrides the configured slow and hung request threshold that are defined in `<requestTiming/>`.  

For more information on the Request Timing feature, please refer to the following documentations:
- link:{url-prefix}/docs/latest/reference/feature/requestTiming-1.0.html[Open Liberty Documentation on requestTiming-1.0 feature]
- link:{url-prefix}/docs/latest/reference/config/requestTiming.html[Open Liberty Documentation on requestTiming Configuration]

[#JDBC]
== Automatic Cleanup of Leaked Connections

Liberty connection management is enhanced with the ability to automatically detect and close unsharable connections that are left open by the application across the end of a request.

Occasionally, application code might forget to close an unsharable connection that it obtains, which prevents the connection from being returned to the connection pool for use by other requests. Over time, these leaked connections can degrade performance and eventually exhaust the connection pool. Liberty connection management now has the ability to detect and automatically close these leaked connections to prevent this from happening.

To take advantage of this new capability, configure one of the Liberty features that leverages the `connectionManager` element. For example, JDBC:
[source, xml]
----
<featureManager>
  <feature>jdbc-4.2</feature>
  <feature>jndi-1.0</feature>
  <!-- more features -->
</featureManager>
----

Configure your data sources and connection factories as usual, which automatically leverage the new capability (To turn it off, configure `autoCloseConnections="false"` on a `<connectionManager>`).
[source, xml]
----
<dataSource id="DefaultDataSource">
  <connectionManager maxPoolSize="10"/>
  <jdbcDriver libraryRef="PostgreSQL"/>
  <properties.postgresql databaseName="TESTDB" serverName="localhost" portNumber="5432"/>
</dataSource>

<library id="PostgreSQL">
  <file name="/usr/local/postgresql/postgresql-42.2.18.jar"/>
</library>
----

Find out more at link:{url-prefix}/docs/latest/reference/config/connectionManager.html[Open Liberty Connection Manager Documentation]

[#SSO]
== Single Sign-On (SSO) LTPA and JWT support authentication filter>>

With this new enhancement users can now use the authentication filter to select which HTTP servlet request should use LTPA and JWT for the SSO authentications. To find out more about this take a look at link:{url-prefix}/blog/2020/07/02/disable-default-cookies-20007.html[Disabling default LTPA cookies for TAI/SPNEGO or default JWT cookies for JWT SSO on Open Liberty 20.0.0.7]


//end::features[]

[#bugs]
== Notable bugs fixed in this release

We’ve spent some time fixing bugs. The following sections describe just some of the issues resolved in this release. If you’re interested, here’s the  link:https://github.com/OpenLiberty/open-liberty/issues?q=label%3Arelease%3A21004+label%3A%22release+bug%22[full list of bugs fixed in 21.0.0.4].

* link:https://github.com/OpenLiberty/open-liberty/issues/16113[Shared Class Cache not generated on Windows]
+
The IBM/OpenJ9 JDK Shared Class Cache may not have been generated on Windows if `IBM_JAVA_OPTIONS/OPENJ9_JAVA_OPTIONS` was not set causing slower startup performance.  With this fix, a Shared Class Cache will be created at `<WLP_USER_DIR>/servers/.classCache` improving the startup performance.

* link:https://github.com/OpenLiberty/open-liberty/issues/16054[HSTS Header not added on responses with 404 status]
+
In certain cases where the response is fully handled by the HTTP transport without invoking the WebContainer engine (e.g-a 404 response), the HTTP Strict-Transport-Security (`HSTS`) header was improperly omitted from the response even though the link:{url-prefix}/docs/21.0.0.3/reference/config/webContainer.html[`addStrictTransportSecurityHeader`] was properly configured.  The HTTP transport's parsing of these properties now has new tracing, the HTTP transport will inspect the response and, when configured to do so, add the `HSTS` header if it is missing and if the scheme is 'https'. The `HTTPDispatcher=all` trace level can be used to see what the resulting header value will look like.

* link:https://github.com/OpenLiberty/open-liberty/issues/15336[Replace DNS lookup with regular expression to get the domain name in SSO Cookie Domain function]
+
A bug in the SSO Cookie domain function caused an unnecessary DNS lookup when sending a regular HTTP Request to generate LTPA token. To improve performance, a regex will mow be used instead to obtain the domain name.

* link:https://github.com/OpenLiberty/open-liberty/issues/15989[Bump netty dependencies to 4.1.62.Final]
+
Although Open Liberty is not vulnerable, we've updated Netty (used by the link:{url-prefix}/docs/21.0.0.3/reference/feature/grpcClient-1.0.html[gRPC Client 1.0] feature) to 4.1.62.Final in order to pull in a fix for a CVE.

== Get Open Liberty 21.0.0.4 now

Available through <<run,Maven, Gradle, Docker, and as a downloadable archive>>.
