---
layout: post
title: "Secrets management in Kubernetes - using HashiCorp Vault"
categories: blog
author_picture: https://avatars3.githubusercontent.com/shamjithantholi
author_github: https://github.com/shamjithantholi
seo-title: Secrets management in Kubernetes - using HashiCorp Vault
seo-description: How to manage secrets in kubernetes containers - using HashiCorp Vault.
blog_description: How to manage secrets in kubernetes cluster - using HashiCorp Vault.
open-graph-image: https://openliberty.io/img/blog/liberty-devops-generic-architecture.png
---
= Secrets management in Kubernetes - using HashiCorp Vault
Shamjith Antholi <https://github.com/shamjithantholi>
:imagesdir: /
:url-prefix:
:url-about: /

[#Intro]

Secrets are confidential information which is very sensitive in nature and hence it's access are restricted. In general, multiple layers of security are used in storing and retriving secrets like passwords and tokens. Kubernetes/OpenShift has provisions internally to secure the secrets, but in many cases application security team does not prefer to store the secrets permanently on kubernetes cluster to which non-application team will have access. Vendor tools like HashiCorp Vault come to the rescue in such requirements. 

== Hashicorp Vault and Kubernetes

HashiCorp vault is a secret management tool which help organisations to store and transmit secrets securely. Identity based access to HashiCorp vault are controlled by well defined HashiCorp Configuration Language (HCL) based 'Policies'. Role-based access control (RBAC) based policies are used for comtrolling human access and Dynamically generated secret based access control are used to authenticate machine access. Vault provides “encryption as a service,” encrypting data in transit (with TLS) and at rest (using AES 256-bit CBC encryption) and hence vault make sure that data is encrypted always. 

This blog is focused on hosting Hashicorp vault server in Kubernetes and also how to securly access vault secrets on kubernetes pods. Kubernetes is a open source platform for managing containerized applications workloads and services that facilitates both declarative configuration and automation. Kubernetes works with Docker runtime engine as well as other wide variety of container engines. Kubernetes cluster can be installed on your own datacenter ( link:https://kubernetes.io/docs/tasks/tools/install-kubectl-linux/[Install kubernetes] ) or directly use a host kubernetes service (eg: link:https://azure.microsoft.com/en-us/services/kubernetes-service/ [Azure kubernetes service] )

#Kubernetes - HashiCorp integration architecture diagram

=== Install Helm chart

Vault community is maintaining Helm chart for vault, install latest version of HELM follow the steps in link:https://helm.sh/docs/intro/install/[Helm installation steps] +
Add HashiCorp to the helm repository using the command "helm repo add hashicorp https://helm.releases.hashicorp.com"

== HashiCorp vault server setup steps on Kubernetes

In this section i will explain the installation steps of Vault server, associated storage cluster and security certificates on Kubernetes cluster.    

As the first step, we need to setup a backened storage repository for vault to store the secrets. We will setup a single instance link:https://www.consul.io server for this purpose (Consul is a default storage solution for vault, other compatible options like k8s volume can also be used for this purpose). +
Find out the latest version of Consul avilable in helm and install it on kubernetes using the below give commands. Before that, create a consule properties file in yaml format

                global:
                    datacenter: vault-blog
                client:
                    enabled: true
                server:
                    replicas: 1
                    bootstrapExpect: 1
                    disruptionBudget:
                        maxUnavailable: 0

                helm search repo hashicorp/consul --versions
                helm template consul hashicorp/consul --namespace vault --version <latest-consul-version> -f consul-values.yaml > consul.yaml
                # Note: correct the 'apiVersion' of 'PodDisruptionBudget' to 'policy/v1' (if wrong) 
                # Note: check if your pod has permission to the path in "data_dir", for test purpose modify it to "data_dir" : "/tmp/consul/data",    
                kubectl create ns vault
                kubectl -n vault apply -f consul.yaml

The result should look like this
        image::/img/blog/consul-server-status.png[Consul server status ,width=70%,align="center"]


#setup steps

== HashiCorp vault - kubernetes integration setup steps

#setup steps

#How secrets are pull into containers

#How secrets can be used in applications in the containers

#Limitations


== Conclusion

