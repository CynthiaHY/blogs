---
layout: post
title: "实现快速启动云原生Java应用程序的打包方法"
# Do NOT change the categories section
categories: blog
author_picture: https://avatars3.githubusercontent.com/tjwatson
author_github: https://github.com/tjwatson
seo-title: 实现快速启动云原生Java应用程序的打包方法 - OpenLiberty.io
seo-description: 您是否知道我们可以重新打包云原生Java应用程序，使其以毫秒为单位启动，而不会影响吞吐量、内存、开发-生产对等性或Java语言特性？并且不需要重构应用程序代码吗？方法就是……
blog_description: "您是否知道我们可以重新打包云原生Java应用程序，使其以毫秒为单位启动，而不会影响吞吐量、内存、开发-生产对等性或Java语言特性？并且不需要重构应用程序代码吗？方法就是……"
open-graph-image: https://openliberty.io/img/blog/checkpoint4.png
open-graph-image-alt: InstantOn checkpoint and restore process
additional_authors:
- name: Vijay Sundaresan
  github: https://github.com/vijaysun-omr
  image: https://avatars0.githubusercontent.com/vijaysun-omr

- name: Laura Cowen
  github: https://github.com/lauracowen
  image: https://avatars0.githubusercontent.com/lauracowen

- name: 张海燕 (翻译)
  github: https://github.com/CynthiaHY
  image: https://avatars0.githubusercontent.com/CynthiaHY

blog-available-in-languages:
- lang: en
  path: /blog/2023/06/29/rapid-startup-instanton.html
- lang: ja
  path: /ja/blog/2023/06/29/rapid-startup-instanton.html

---
= 实现快速启动云原生Java应用程序的打包方法
Thomas Watson <https://github.com/tjwatson>
:imagesdir: /
:url-prefix:
:url-about: /
//Blank line here is necessary before starting the body of the post.

您是否知道我们可以重新打包云原生Java应用程序，使其以毫秒为单位启动，而不会影响吞吐量、内存、开发-生产对等性或Java语言特性？并且不需要重构应用程序代码吗？方法就是……

== 提高启动速度的必要性

在无服务器（serverless）环境中，通过在没有请求处理时关闭不需要的应用程序实例，缩容至0（scale-to-zero）可以帮助降低部署应用程序的总体云计算成本。当应用程序的活动开始时，新的实例能快速启动，而不会给应用程序终端用户带来明显的延迟。

尽管JDK技术有很大改进，使得它可以在不到1秒的时间内启动，比如类数据共享和动态AOT编译，但它的启动速度仍然不够快，无法支持从零缩放。但是，JDK对于优化吞吐量和内存、确保开发与生产的一致性以及支持各种Java语言特性等非常重要。那么，我们如何既改善启动时间，又从完整运行的JDK中获益呢？

Open Liberty运行时中的InstantOn功能使用IBM Semeru JDK和称为link:https://criu.org/Main_Page[用户空间中的检查点/恢复点](CRIU)的Linux技术来获取应用程序进程的检查点或时间点快照。然后可以非常快速地恢复这个检查点，使应用程序进程恢复到使用检查点时的状态。应用程序可以多次恢复，因为Open Liberty和Semeru JDK保留了容器中每个恢复进程的唯一性。每个恢复的应用程序进程都可以不必先经历整个启动序列而运行，从而节省高达90%的启动时间（取决于您的应用程序）。InstantOn只需要对Java应用程序进行很少的修改就可以实现这种改进。

下图演示了如何在容器镜像构建期间生成检查点，通过将它们恢复到应用程序进程的检查点阶段来快速启动生产环境中多个应用程序实例的。

[.img_border_light]
image::/img/blog/checkpoint4.jpg[diagram of the checkpoint and restore process,width=70%,align="center"]

InstantOn不能在容器镜像构建之外使用。应用程序容器镜像提供了一个一致的环境，这是确保Open Liberty应用程序进程可靠恢复所必需的。由于InstantOn检查点包含在应用程序容器镜像的最后一层中，因此从检查点创建到镜像恢复期间，镜像底层中的资源不会发生变化。

下面的教程将引导您使用Linux上的 Open Liberty Java运行时、InstantOn、IBM Semeru JDK和Podman容器工具对应用程序进行容器化。有关使用Open Liberty容器化应用程序的信息，请参阅link:/guides/containerize-podman.html[使用Podman进行容器化微服务]指南。

== 检查点/恢复容器化应用程序的先决条件

目前，link:/blog/2023/06/27/23.0.0.6.html[Open Liberty 23.0.0.6]或更高版本只支持在x86-64/amd64架构上运行InstantOn。我们所有的测试都是在RHEL 9.0和Ubuntu 22.04上完成的，但如果具备以下先决条件，也可以在其他Linux发行版本上运行:

-	内核必须支持Linux link:https://man7.org/linux/man-pages/man7/capabilities.7.html[CAP_CHECKPOINT_RESTORE]功能，此功能是在内核5.9版本中引入的
-	必须安装Linux发行版最新版本的Podman
-	Linux发行版必须允许使用Podman或Docker来执行特权容器构建

For more information about the runtime and host build system prerequisites, see the link:/docs/latest/instanton.html#prereq[Open Liberty InstantOn documentation].
有关运行时和主机构建系统先决条件的更多信息，请参阅link:/docs/latest/instanton.html#prereq[Open Liberty InstantOn文档]

== 创建一个应用程序WAR文件

If you don’t have an application of your own handy, you can follow along with an example application from the link:/guides/getting-started.html[Getting started with Open Liberty guide].

First, clone the link:https://github.com/openliberty/guide-getting-started[Git repository] for the guide:

[source,console]
----
git clone https://github.com/openliberty/guide-getting-started.git
cd guide-getting-started
----

Then, build the application, which is in the `finish/` directory, and deploy it to Open Liberty:

[source,console]
----
cd finish
mvn liberty:run
----

When you see the following message, your Open Liberty instance is ready:

[source,console]
----
The defaultServer server is ready to run a smarter planet.
----

Check out the service at the http://localhost:9080/dev/system/properties URL.
Stop the running Open Liberty instance by pressing **CTRL+C** in the command-line session where you started Open Liberty.

Lastly, build the WAR for the application:

[source,console]
----
mvn package
----

This command builds a `target/guide-getting-started.war` archive. We can now include this WAR in a container image that uses the InstantOn feature.

== Testing the startup time of your application

For comparison of how long it takes your Open Liberty application container image to start both with and without InstantOn, we describe how to build the container image without InstantOn first. Then, we describe how to build with InstantOn and run the resulting containers.

=== Containerizing the Open Liberty application without InstantOn

Build the application container image without InstantOn:

[source,console]
----
podman build -t getting-started .
----

This command creates the getting-started container image without any checkpoint image.

Run this application container:

[source,console]
----
podman run --name getting-started --rm -p 9080:9080 getting-started
----

Note the amount of time Open Liberty takes to report it is started and check out the service running in the container at the http://localhost:9080/dev/system/properties URL. After you finish checking out the application, stop the running container by pressing **CTRL+C** in the command-line session where you ran the `podman run` command.

=== Containerizing the Open Liberty application with InstantOn

The Open Liberty container image contains the prerequisites for building an application container image with a checkpointed runtime process. Applications can use the Open Liberty image as a base to build their own application container images and from that, create their own application container image with a checkpointed process.

[#build]
==== Build the application container image and checkpoint the application

An InstantOn checkpoint is created by starting the Open Liberty runtime during the application container image build step. During this startup, the runtime processes the configuration, loads all the enabled features, and starts processing the configured application. Depending on the needs of your application, you can choose one of two specific phases during Open Liberty startup at which to checkpoint the process. You must configure the Dockerfile to specify your chosen phase (as we show later).

The official link:/docs/latest/container-images.html[Open Liberty images from the IBM Container Registry] (ICR) include all the prerequisites that are needed for InstantOn to checkpoint an application process. For this example, the `getting-started` application container image is using the `icr.io/appcafe/open-liberty:full-java11-openj9-ubi` image from ICR as the parent image. Currently, InstantOn is supported only with the Java 11 and Java 17-based UBI images of Open Liberty.

Update the application Dockerfile by adding a `RUN` command for the `checkpoint.sh` script to the end of the file, as shown in the following example:

[source,console]
----
FROM icr.io/appcafe/open-liberty:full-java11-openj9-ubi
ARG VERSION=1.0
ARG REVISION=SNAPSHOT
LABEL \
  org.opencontainers.image.authors="Your Name" \
  org.opencontainers.image.vendor="IBM" \
  org.opencontainers.image.url="local" \
  org.opencontainers.image.source="https://github.com/OpenLiberty/guide-getting-started" \
  org.opencontainers.image.version="$VERSION" \
  org.opencontainers.image.revision="$REVISION" \
  vendor="Open Liberty" \
  name="system" \
  version="$VERSION-$REVISION" \
  summary="The system microservice from the Getting Started guide" \
  description="This image contains the system microservice running with the Open Liberty runtime."

COPY --chown=1001:0 src/main/liberty/config/ /config/
COPY --chown=1001:0 target/*.war /config/apps/

RUN configure.sh
RUN checkpoint.sh afterAppStart
----

This configuration adds the application process checkpoint as the last layer of the application container image. The `checkpoint.sh` script allows you to specify either `afterAppStart` or `beforeAppStart` to indicate which phase of the startup performs the process checkpoint.

Two options are available to determine whether the checkpoint occurs before or after the application itself starts:

- `beforeAppStart`: The checkpoint happens after processing the configured application metadata. If the application has any components that get run as part of the application starting, the checkpoint is taken before executing any code from the application. This option is the earliest checkpoint phase that is offered by InstantOn.
- `afterAppStart`: This option is the latest phase where a checkpoint can happen, so it has the potential to provide the fastest startup time when restoring the application instance. The checkpoint happens after all configured applications are reported as started. This phase happens before opening any ports for listening to incoming requests for the applications.

The `afterAppStart` phase typically provides the quickest startup time for an application, but it also might cause some application code to run before the server process checkpoint happens. Since the `getting-started` application used in this tutorial does not do anything in its startup logic that would cause problems in restoring, we can use the `afterAppStart` phase for it.

For InstantOn to take a checkpoint of and restore a process, the CRIU binary requires additional link:/docs/latest/instanton.html#linux-capabilities[Linux capabilities]. The Open Liberty container image includes the necessary capabilities already granted to the binary. However, the container must also have these capabilities granted when it is launched.

With podman, you can use the `-–cap-add` and `--security-opt` options to grant the container build the necessary capabilities to take a checkpoint during the container build step. The user who launches the Podman container must have the authority to grant it the necessary Linux capabilities, so you must run the following command as root or `sudo`:

[source,console]
----
podman build \
   -t dev.local/getting-started-instanton \
   --cap-add=CHECKPOINT_RESTORE \
   --cap-add=SYS_PTRACE\
   --cap-add=SETPCAP \
   --security-opt seccomp=unconfined .
----

The last instruction in the Dockerfile is to run the `checkpoint.sh` script. When you execute the previous Podman build command, it launches Open Liberty to perform the checkpoint at the phase specified in the Dockerfile. After the container process data is persisted, Open Liberty stops and the container image build completes. The produced application container image contains the checkpoint process data as the last layer of the container image. The output looks something like the following example:

[source,console]
----
Performing checkpoint --at=afterAppStart

Launching defaultServer (Open Liberty 23.0.0.6/wlp-1.0.78.cl230620230612-1100) on Eclipse OpenJ9 VM, version 11.0.19+7 (en_US)
[AUDIT   ] CWWKE0001I: The server defaultServer has been launched.
[AUDIT   ] CWWKG0093A: Processing configuration drop-ins resource: /opt/ol/wlp/usr/servers/defaultServer/configDropins/defaults/keystore.xml
[AUDIT   ] CWWKG0093A: Processing configuration drop-ins resource: /opt/ol/wlp/usr/servers/defaultServer/configDropins/defaults/open-default-port.xml
[AUDIT   ] CWWKZ0058I: Monitoring dropins for applications.
[AUDIT   ] CWWKZ0001I: Application guide-getting-started started in 1.886 seconds.
[AUDIT   ] CWWKC0451I: A server checkpoint "afterAppStart" was requested. When the checkpoint completes, the server stops.
----

[#run]
==== Run the InstantOn application image

Run the `getting-started-instanton` container with the following command:

[source,console]
----
podman run \
  --rm \
  --cap-add=CHECKPOINT_RESTORE \
  --cap-add=SETPCAP \
  --security-opt seccomp=unconfined \
  -p 9080:9080 \
  getting-started-instanton
----

The `--cap-add` options grant the container the two Linux capabilities that CRIU requires to restore the application process. When Open Liberty restores the application process, it logs the following messages:

[source,console]
----
[AUDIT   ] Launching defaultServer (Open Liberty 23.0.0.6/wlp-1.0.78.cl230620230612-1100) on Eclipse OpenJ9 VM, version 11.0.19+7 (en_US)
[AUDIT   ] CWWKZ0001I: Application guide-getting-started started in 0.233 seconds.
[AUDIT   ] CWWKT0016I: Web application available (default_host): http://850ba43df239:9080/dev/
[AUDIT   ] CWWKT0016I: Web application available (default_host): http://850ba43df239:9080/metrics/
[AUDIT   ] CWWKT0016I: Web application available (default_host): http://850ba43df239:9080/health/
[AUDIT   ] CWWKT0016I: Web application available (default_host): http://850ba43df239:9080/ibm/api/
[AUDIT   ] CWWKC0452I: The Liberty server process resumed operation from a checkpoint in 0.283 seconds.
[AUDIT   ] CWWKF0012I: The server installed the following features: [cdi-4.0, distributedMap-1.0, jndi-1.0, json-1.0, jsonb-3.0, jsonp-2.1, monitor-1.0, mpConfig-3.0, mpHealth-4.0, mpMetrics-5.0, restfulWS-3.1, restfulWSClient-3.1, ssl-1.0, transportSecurity-1.0].
[AUDIT   ] CWWKF0011I: The defaultServer server is ready to run a smarter planet. The defaultServer server started in 0.297 seconds.
----

If Open Liberty fails to restore the checkpoint process, it recovers by launching without the checkpoint image and logs the following message:

[source,console]
----
CWWKE0957I: Restoring the checkpoint server process failed. Check the /logs/checkpoint/restore.log log to determine why the checkpoint process was not restored. Launching the server without using the checkpoint image.
----

Check how long it took for Open Liberty to start and compare this to the time it took without InstantOn.

== Performance results

InstantOn improves startup time of Open Liberty applications significantly by restoring the process from the checkpointed state. The improvement in the time to first response (i.e. the time taken to serve the first request) is also impressive but obviously more of the application logic runs after the restore in that case. We measured both metrics for multiple applications running in containers and using the `afterAppStart` checkpoint phase.

- link:https://github.com/HotswapProjects/pingperf-quarkus/[Pingperf] is a very simple ping-type application involve a single REST endpoint.
- link:https://github.com/johnaohara/quarkusRestCrudDemo/[Rest crud] is a bit more complicated, and involves JPA and a remote database.
- link:https://github.com/blueperf/acmeair-mainservice-java#acme-air-main-service---javaliberty/[AcmeAir Microservice Main] uses the MicroProfile features.

image::/img/blog/startup.png[Startup time in ms,width=70%,align="center"]

{empty} +
{empty} +

image::/img/blog/response.png[First response time in ms,width=70%,align="center"]

These experiments show a healthy improvement in startup times for all 3 applications and the time to first response is also improved by up to 8.8x when compared with normal JVM mode without InstantOn.footnote:[These experiments were run on a 24-core Linux X86-64 system, and `taskset -c` was used to allocate 4 cores to the Open Liberty process running in containers in each case. Startup time is measured from the time the Open Liberty server startup is initiated to the time the server is ready to accept requests, as denoted by `The <server name> server is ready to run a smarter planet.` message in the `messages.log`. The time it takes to start the container itself is also included in the results shown. InstantOn versus normal startup times for these applications are shown here in milliseconds. Your results might vary based on your environment, hardware and software installed on your system, and other factors.]

== Summary

This post describes how to configure your cloud-native application to start almost immediately by using the Open Liberty InstantOn feature to produce an application container image. The key value proposition of InstantOn is that you can repackage your cloud-native Java applications to start in milliseconds, without compromising on throughput, memory, development-production parity, or Java language features.
This feature is now available in link:/blog/2023/06/27/23.0.0.6.html[Open Liberty 23.0.0.6] on the X86-64/AMD64 platforms running in the public cloud AWS EKS and Azure AKS environments.

In the future, we are planning to broaden our platform coverage and expand to be able to run in more managed public and hybrid cloud environments. We also intend to explore supporting InstantOn with an even larger set of Open Liberty features. For more details about Open Liberty InstantOn, see the link:/docs/latest/instanton.html[Faster startup for containerized applications with Open Liberty InstantOn] documentation, which links to more elaborate discussion on known limitations and information on the Semeru JDK support for this feature.
