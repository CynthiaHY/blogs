---
layout: post
title: "Bind an Operator Managed PostgreSQL Database to a JPA Application in a Kubernetes Cluster"
categories: blog
author_picture: https://avatars3.githubusercontent.com/mezarin
author_github: https://github.com/mezarin
seo-title: Bind an Operator Managed PostgreSQL Database to a JPA Application in a Kubernetes Cluster - OpenLiberty.io
seo-description: Speed up development by making it easier for application developers to bind operator managed services to applications.
blog_description: "Speed up development by making it easier for application developers to bind operator managed services to applications"
open-graph-image: https://openliberty.io/img/blog/ol-stack-jpa-app-db-bind-browser-data-entry.png
---
= Bind an Operator Managed PostgreSQL Database to a JPA Application in a Kubernetes Cluster
Edward Mezarina <https://github.com/mezarin>

Binding your Microservice application to operator based services (i.e databases, etc) has now been made easier through automatic collection of service data, deployment of needed resources, and data sharing with the application.

== Open Liberty devfile stack

The link:https://github.com/OpenLiberty/application-stack#open-liberty-application-stack[Open Liberty devfile stack] provides much of the infrastructure (Open Liberty, Maven/Gradle, Open J9, etc.) needed to start developing applications that use Maven or Gradle, and it is made available as Maven and Gradle development images. These images are used by the devfiles provided by the stack to serve as the base for building and running your applications. 

The Open Liberty devfile stack provides two fully configured link:https://docs.devfile.io/devfile/2.1.0/user-guide/index.html[devfiles]: A link:https://github.com/devfile/registry/blob/main/stacks/java-openliberty/devfile.yaml[Maven based devfile] and a link:https://github.com/devfile/registry/blob/main/stacks/java-openliberty-gradle/devfile.yaml[Gradle based devfile]. These devfiles will allow you to deploy your Maven or Gradle built applications with ease as these devfiles define the environment and set of steps needed to build and deploy your application using the Open Liberty runtime.

== OpenShift Do (odo)

link:https://odo.dev[Odo] is a simple CLI tool that you use to create devfile based components that interact directly with your Kubernetes cluster to setup the environment, build/deploy/access/debug your application, and link services to odo components. Directives to manage the environment and application are provided by a component's devfile.

== Service Binding Operator

The link:https://github.com/redhat-developer/service-binding-operator/blob/master/README.md[Service Binding Operator] makes it easier for developers to bind operator managed services (i.e. databases) to applications. More specifically, the operator will collect service data, deploy resources (i.e. secrets, configmaps) containing that data, and will make the data available to the application through the ServiceBinding custom resource it provides.

== Try it out

To begin, you need three things:

- Kubernetes cluster. For this blog, we will be using an Openshift cluster. Be sure to log in. Odo will interact with your kubernetes cluster.
- Openshift Do. If you have not already installed odo, do so now by following the instructions outlined in the link:https://odo.dev[odo] documentation. Be sure to install version 2.2.4 and above.
- An application that uses a PostgreSQL database. For this blog, we will be using the Open Liberty stack link:https://github.com/OpenLiberty/application-stack-samples/tree/main/jpa[sample JPA application]


Install the needed operators.

If you have the right priviledges, you can use the OpenShift console to install these operators. You do this by navigating to `Operators->OperatorHub` and searching/selecting/installing a couple of operators from the catalog.

- Service Binding Operator (provided by Red Hat)

Use the OpenShift console (`Operators->OperatorHub`) to install this operator. Be sure to install version 0.9.1 and above.

- PostgreSQL Operator (provided by Dev4Ddevs.com)

Before installing this operator, create the project/namespace under which the application will be deployed. This operator is namespace scoped, so it needs to be installed in the same namespace where the application will be deployed.

[source,sh]
----
$ odo project create service-binding-demo
----

Use the OpenShift console (`Operators->OperatorHub`) to install this operator. Be sure to pick `service-binding-demo` as the namespace in which to install it.

Clone the application repository.

[source,sh]
----
$ git clone https://github.com/OpenLiberty/application-stack-samples.git && \
  cd application-stack-samples/jpa
----

Create a Java Open Liberty component.

If you want the application to be built and deployed using Maven:

[source,sh]
----
$ odo create java-openliberty mysboproj
----

If you want the application to be built and deployed using Gradle:

[source,sh]
----
$ odo create java-openliberty-gradle mysboproj
----

Push the application to the cluster.

[source,sh]
----
$ odo push
----

So far, the application has been deployed on your cluster. However, the application is not ready to be used yet because the application does not have the data needed to access the database, and the PostgreSQL database instance has not been created. Let's create the database instance next.

Display the service providers and services available in the cluster.

[source,sh]
----
odo catalog list services
Services available through Operators
NAME                                CRDs
postgresql-operator.v0.1.1          Backup, Database
service-binding-operator.v0.9.1     ServiceBinding, ServiceBinding
----

Generate the yaml config of the Database resource/service provided by the postgresql-operator.v0.1.1 operator and store it in a file. We do this because we need to edit that file to modify some access information and to tell the Service Binding Operator, in annotation form, what data provided by this service needs to be bound to the application.

[source,sh]
----
odo service create postgresql-operator.v0.1.1/Database --dry-run > db.yaml
----

Modify the database name, user, and password values under the spec section in db.yaml

[source,sh]
----
  databaseName: "sampledb"
  databasePassword: "samplepwd"
  databaseUser: "sampleuser"
----

Add the needed annotations under the metadata section in db.yaml. 

[source,sh]
----
metadata:
  name: sampledatabase
  annotations:
    service.binding/db_name: 'path={.spec.databaseName}'
    service.binding/db_password: 'path={.spec.databasePassword}'
    service.binding/db_user: 'path={.spec.databaseUser}'
----

Generate the Database service devfile configuration.

[source,sh]
----
odo service create --from-file db.yaml
----

Push the updates to the cluster.

[source,sh]
----
odo push
----

We have now created a Dev4Ddevs Database resource instance, which in turn triggered the creation of a PostgreSQL database instance. However, the application is still not usable because it does not have the data needed to connect to the database. Let's solve that next.

List the available services to which the application can be bound. The PostgreSQL database service should be listed.

[source,sh]
----
odo service list

NAME                        MANAGED BY ODO      STATE      AGE
Database/sampledatabase     Yes (mysboproj)     Pushed     50s
----

Generate the service binding devfile configuration.

[source,sh]
----
odo link Database/sampledatabase
----

Push the updates to the cluster. 

[source,sh]
----
odo push
----

With this last `odo push` command, we triggered the creation of a secret containing the database connection information, and the pod hosting the application is restarted with the database connection information, contained in the secret, as environment variables.

That is all. The PostgreSQL database instance was created, and the application was deployed and bound to the database. Let's make sure we can use the application next.

Find the URL to access the application through a browser.

[source,sh]
----
odo url list

Found the following URLs for component mysboproj
NAME     STATE      URL                                                                      PORT     SECURE     KIND
ep1      Pushed     http://ep1-mysboproj-service-binding-demo.apps.my.os.cluster.ibm.com     9080     false      route
----

The default endpoint name assigned by the stack's devfile is ep1.

Open a browser and go to the URL shown by the previous step. Click "Create New Person" button.

[.img_border_light]
image::/img/blog/ol-stack-jpa-app-db-bind-browser-main.png[Main Page,width=70%,align="center"]

Enter a user's name and age via the form shown on the page, and click  `Save`. The data is now persisted in the PostgreSQL database.

[.img_border_light]
image::/img/blog/ol-stack-jpa-app-db-bind-browser-data-entry.png[Data Input Page,width=70%,align="center"]

After you save the data to the postgreSQL database, notice that you are re-directed to the PersonList.xhtml page. The data being displayed was retrieved from the PostgreSQL database.

[.img_border_light]
image::/img/blog/ol-stack-jpa-app-db-bind-browser-show-data.png[Data Display Page,width=70%,align="center"]

For a more detail set of instructions visit the link:https://github.com/OpenLiberty/application-stack-samples/blob/main/jpa/README.md[Open Liberty stack sample JPA documentation].

== Learn more

- To learn more about odo, see https://odo.dev[odo.dev].
- For more details about the Open Liberty devfile stack, open an issue, or create a pull request, go to the https://github.com/OpenLiberty/application-stack[Open Liberty Application Stack GitHub repo]. For questions or comments, contact us on link:https://gitter.im/OpenLiberty/developer-experience[Gitter].
- For instructions on how to bind an operator managed PostgreSQL database to a JPA Application on Minikube, see the https://github.com/OpenLiberty/application-stack-samples/blob/main/jpa/README-minikube.md[Open Liberty Stack sample JPA Minikube documentation].
- For instructions on how to deploy Maven built applications using the Open Liberty devfile stack, see https://openliberty.io/blog/2021/01/20/open-liberty-devfile-stack.html[Develop cloud-native Java applications directly in OpenShift with Open Liberty and odo]
- For instructions on how to deploy Gradle built applications using the Open Liberty devfile stack, see https://openliberty.io/blog/2021/08/30/binding-app-to-postgresql-db-with-odo-and-ol-stack.html[Cloud-native Development of Gradle Built Applications with the Open Liberty Devfile Stack]
- For more information on how to use JPA to access and persist data for your microsevice, see this link:https://openliberty.io/guides/jpa-intro.html[JPA intro Open Liberty guide].