---
layout: post
title: "Continuous integration and delivery (CI/CD) of cloud-native Java applications using Azure DevOps service"
categories: blog
author_picture: https://avatars3.githubusercontent.com/shamjithantholi
author_github: https://github.com/shamjithantholi
seo-title: Continuous integration and delivery (CI/CD) of cloud-native Java applications using Azure DevOps service - OpenLiberty.io
seo-description: How to build a DevOps pipeline for a cloud-native Java application with tools available exclusively on Azure platform.
blog_description: How to build a DevOps pipeline for a cloud-native Java application with tools available exclusively on Azure platform.
open-graph-image: https://openliberty.io/img/blog/liberty-devops-generic-architecture.png
---
= Continuous integration and delivery (CI/CD) of cloud-native Java applications using Azure DevOps
Shamjith Antholi <https://github.com/shamjithantholi>
:imagesdir: /
:url-prefix:
:url-about: /

[#Intro]

Azure DevOps service is an SaaS/on-premise offering from microsoft using which we can create the complete Continuous integration and continuous deployment (CI/CD) pipeline exclusively with Azure based tools (An non-Azure external resource called 'Snyk' is also added to this blog for the security scan purpose because security scan is an important step in CI/CD process ). This pipeline has the provision to execute all the CI/CD functions like application code build, security scans, test case execution and deployment which helps to release products on a more frequent basis without compromising on quality. In this blog post, we'll discuss how you can use link:https://dev.azure.com[Azure DevOps] to automate the CI/CD process for building, testing, and deploying your cloud-native Java applications that run on link:https://openliberty.io[Open Liberty]. As the CI/CD process is triggered by source changes in Git, this is also known as the GitOps approach to DevOps. 

The following diagram shows a simple architecture for a Azure DevOps build and deployment pipeline that builds and deploys a Jakarta EE and MicroProfile application in Azure Kubernetes cluster environment. When a code change is made in the link:https://azure.microsoft.com/en-us/services/devops/repos/[Azure Git repository], Azure Git will trigger link:https://azure.microsoft.com/en-us/services/devops/pipelines/[Azure build pipeline], Scans the application dependencies using link:https://snyk.io[Snyk plugin] and generates a link:https://www.docker.com[Docker] container image of the application with Open Liberty as its runtime, saves the image to a link:https://azure.microsoft.com/en-us/services/container-registry/[Azure container registry], finally, link:https://azure.microsoft.com/en-us/services/devops/pipelines/[Azure release pipeline] will automatically trigger the deployment to link:https://azure.microsoft.com/en-us/services/kubernetes-service/#overview[Azure kubernetes services].

image::/img/blog/aks-deployment-pipeline1.png[Azure devops deployment pipeline architecture diagram,width=90%,align="center"]

In this blog post, I will assume that you have a basic understanding of Git, Docker, and Kubernetes.

== Provisioning and configuring Microsoft Azure resources and Snyk to set up CI/CD of a cloud-native Java application

To setup a CI/CD pipeline on Azure platform, we need to provision a series of resources on Azure. Below given are the details of required Azure resources and the steps to provision it. 

*Azure Account creation:* An azure account is a pre-requisite to create any resource in Azure. Login to link:https://portal.azure.com[Microsoft Azure] and subscribe to "Pay as you go with Azure". More details can be found in link:https://openliberty.io/guides/cloud-azure.html#additional-prerequisites[Azure subscription steps]

*Azure resource group:* Azure Resource group are a common identifier for all the related resources created in an Azure account. Resource groups are helpful for the resources that share the same lifecycle to easily deploy, update, and delete them as a group. To create a resource group, go to home page of link:https://portal.azure.com[Microsoft Azure] and click on "Create a resource" button. Search for "resource group" and create a resource group following the instructions.  More details about Azure resource group can be found at link:https://openliberty.io/guides/cloud-azure.html#creating-a-resource-group[Azure resource group using CLI] 

*Azure container registry:* We need to provision a docker repository on Azure platform to store the container images. To create a Azure container registry, go to home page of link:https://portal.azure.com[Microsoft Azure] and click on "Create a resource" button. Search for "container registry" and create a container registry following the instructions. Bind this container registry with the previously created 'resource group' selecting the same on the creation steps. YOu can creare Azure container registry from CLI by following the steps in link:https://openliberty.io/guides/cloud-azure.html#creating-a-container-registry[Azure registry using CLI]

*Azure kubernetes service:* We need to provision a containerization platform on Azure to deploy our application. Azure kubernetes service is a SaaS based platform offered by Azure. To provision a kubernetest cluster on Azure, go to home page of link:https://portal.azure.com[Microsoft Azure] and click on "Create a resource" button. Search for "kubernetes service" and create the cluster following the instructions. Detailed cluster provisioning steps are available in link:https://docs.microsoft.com/en-us/azure/aks/learn/quick-kubernetes-deploy-portal?tabs=azure-cli[Quick start guide]. Bind this kubernetes cluster with the previously created 'resource group' selecting the same on the creation steps. You can create AKS from CLI by following the steps in link:https://openliberty.io/guides/cloud-azure.html#provisioning-a-cluster[AKS using CLI]

*Azure DevOps:* Azure DevOps is a platform where we can create the complete Azure based CI/CD pipeline which will be making use of all the services explained in this section. To provision a Azure DevOps pipeline, go to link:https://dev.azure.com/[Azure DevOps] and create an Azure DevOps organization using an existing Git account or using a microsoft account. Create a new project under this newly created organization. 

*Snyk setup :* Snyk can be used to do the security scanning of the container images (you can use any other scaning product for this) which will make sure that the application which we are going to deploy on Azure Kubernetes service are safe from any vulnerabilities. Snyk is not a Azure product. To do the scan of images saved on Azure container registry using Snyk, we need to create an account in Snyk portal and also we need to integrate Snyk with Azure DevOps. As the first step, go to link:https://app.snyk.io/[Synk] and create an account using an existing github account. + 

Next step is to configure the snyk on Azure DevOps. Login to https://dev.azure.com/<your-org> and click on "Organization settings". Click on "Extensions" on "General" section. Click on "browse marketplace" button. From the link:https://marketplace.visualstudio.com/azuredevops?utm_source=vstsproduct&utm_medium=L1BrowseMarketplace&targetId=5147ea18-72ed-4b60-bf15-5eda7c6b7a49[Azure marketplace] page, search for "Snyk" and install the same on your Azure devops organization following the instructions. 

*Service connections:* Service connections are creating reusable connection variables in Azure DevOps, connection to Azure internal components as well as connections to other external components(like Snyk, in this case). These variables can be used in Azure DevOps pipeline code. We need to create 3 service connections for using in Azure DevOps pipeline

              1. **Container Registry:** Azure DevOps will connect to Azure Container Registry using this connection variable. To create this 
                  variable, go to https://dev.azure.com/<your-org/ and select your Azure DevOps project. Click on the   
                  "Project settings" and click on "Service connections" under the section "Pipelines". Click on "New service connection" and search for "registry", select "Docker Registry" from the search results and click "Next" button. Select "Azure Container Registry" from the options and follow the further steps to create the service connection. +
              2. **Azure Kubernetes service** Azure DevOps will connect to Azure Kubernetes Service using this connection variable. To create this 
                  variable, go to https://dev.azure.com/<your-org/ and select your Azure DevOps project. Click on the   
                  "Project settings" and click on "Service connections" under the section "Pipelines". Click on "New service connection" and search for "kubernetes", select "Kubernetes" from the search results and click "Next" button. Select "Azure Subscription" from the "Authentication method" and follow the further steps to create the service connection. + 
              3. **Snyk** Azure DevOps will connect to Snyk using this connection variable. Go to https://dev.azure.com/<your-org/ and select your 
                  Azure DevOps project. Click on the "Project settings" and click on "Service connections" under the section "Pipelines". Click on "New service connection" and search for "snyk", select "Snyk Authentication" and follow the further steps to create the service connection. Steps to generate API token from snyk portal is explained in this service connection setup page.     

== Azure DevOps contineous integration pipeline setup steps

*Azure Git repository and Open Liberty code setup* After creating all the required resources using the above steps, now we will create a Git based  source code repository on Azure platform. For creating the code repo, go to to https://dev.azure.com/<your-organisation>/_git/<your-project> and click on "Repos" and create a new git repository, follow the further steps to create the repository (repository checkout/check-in steps are provided in this "Repos" page, if you are doing it using HTTPS, click on "Genarate Git Credentials" to generate the credentials, for SSH checkout, click on "SSH --> Manage SSH Keys" and generate new keys). +
Check-in to the Azure git the Open Liberty code generated by the link:https://openliberty.io/start/[Liberty Starter] or by following the pattern described in link:https://github.com/OpenLiberty/ci.docker[Open Liberty Images]. The link:https://openliberty.io/guides/containerize.html[Containerize guide] is a helpful resource that goes into more details on how to create a container image for applications running on Liberty. Add the kubernetes deployment configuration file to this same repository

*Azure build pipeline setup* Go to https://dev.azure.com/<your-organisation>/_git/<your-project> page and follow these steps to create a pipeline. 

              * Click on "Pipelines" and then click on "Create Pipeline". 
              * Select "Azure Repos Git" and then select your repository from the next page. 
              * On "Configure your pipeline" page,select "Docker" (with description 'Build and push an image to Azure Container Registry') option. 
              * Select your azure subscription and click on "continue" button. Sign in to microsoft account on popup. 
              * Select container registry from the drop down, write the docker image name (which will be created and pushed to container registry by this build pipeline), make changes to default Dockerfile name (if any) and click on "Validate and configure" button. 

At this stage a pipeline yaml will be generated which you should configure according to your needs, make the follow changes 

              * Modify the git trigger branch, if any 

                          trigger: 
                            - main 

              * Under "variables" section in the yaml, change the image repository name to "liberty-app" ( or anything of your choice) and tag 
                 name to "latest" (or anything of your choice) 

                           imageRepository: 'liberty-app' 
                           tag: 'latest'              

              * Add maven build command (mvn package) as the first step in the build stage 

                            stages:
                            - stage: Build
                              displayName: Build and push stage
                              jobs:
                              - job: Build
                                displayName: Build
                                pool:
                                  vmImage: $(vmImageName)
                                steps:
                                - script: mvn package

              * Add "Snyk" details after the build step to scan all the dependency jar files used in this application. Keep the cursor above "mvn package" step and search for Snyk on the "Task" section on the right side of the page. Select the API token and "Application" in "What do you want to test?" dropdown anc click "Add" button

image::/img/blog/add-snyk-scan-to-stage.png[Add snyk scan to stage,width=90%,align="center"]

              * When the "Docker" task is completed, docker image will be created based on the instructions on "Dockerfile" and uploaded to Azure container registry. 

              * The last task required on build pipeline is to copy the deployment config file to azure staging repository for accessing the same on azure deployment pipeline (like the file 'azure-aks.yaml' in the below given example code). A complete sample Azure build pipeline code is given below. Save this code and run the pipeline 

                                    trigger:
                                    - main
                                    resources:
                                    - repo: self
                                    variables:
                                      # Container registry service connection established during pipeline creation
                                      dockerRegistryServiceConnection: '********'
                                      imageRepository: 'liberty-app'
                                      containerRegistry: '<registry-name>.azurecr.io'
                                      dockerfilePath: '$(Build.SourcesDirectory)/Dockerfile'
                                      tag: 'latest'
                                      # Agent VM image name
                                      vmImageName: 'ubuntu-latest'
                                    stages:
                                    - stage: Build
                                      displayName: Build and push stage
                                      jobs:
                                      - job: Build
                                        displayName: Build
                                        pool:
                                          vmImage: $(vmImageName)
                                        steps:
                                        - script: mvn package
                                        - task: SnykSecurityScan@1
                                          inputs:
                                            serviceConnectionEndpoint: 'snyk'
                                            testType: 'app'
                                            monitorWhen: 'always'
                                            failOnIssues: true
                                        - task: Docker@2
                                          displayName: Build and push an image to container registry
                                          inputs:
                                            command: buildAndPush
                                            repository: $(imageRepository)
                                            dockerfile: $(dockerfilePath)
                                            containerRegistry: $(dockerRegistryServiceConnection)
                                            tags: |
                                              $(tag)
                                        - task: CopyFiles@2
                                          displayName: 'Copy Files to: $(build.artifactstagingdirectory)'
                                          inputs:
                                            Contents: 'azure-aks.yaml'
                                            TargetFolder: '$(build.artifactstagingdirectory)'      
                                        - task: PublishBuildArtifacts@1
                                          displayName: 'Publish Artifact: drop'

*Azure deployment pipeline setup* Go to https://dev.azure.com/<your-organisation>/_git/<your-project> page and follow these steps to create a pipeline. 
                      * Click on "Releases" under "Pipelines" section, click on "New pipeline", a "Select template" popup will be available

                      * Search for "Deploy to kubernetes cluster" in "Select template page" and select the same. Give a name to the stage and close the same.
       
                      * Click on 'Add an artifact' to map the associated build pipeline to this deployment pipeline, select the required details and add it

image::/img/blog/azure-deploy6.png[Azure devops deployment pipeline setup stage 1 diagram,width=70%,align="center"]

                      * Click on "1 job, 1 task" link on the deployment stage
                 
image::/img/blog/azure-deploy1.png[Azure devops deployment pipeline setup stage 2 diagram,width=50%,align="center"]

                      * Select the agent on which the deployment instructions need to be executed (Click on 'Agent Job' --> then select 'Azure Pipelines' from 'Agent pool' --> select 'ubuntu-*' from 'Agent Specification')

image::/img/blog/azure-deploy2.png[Azure devops deployment pipeline setup stage 3 diagram,width=50%,align="center"]

                      * Make sure that deployment configuration file is available on the 'drop' folder in 'Artifact download' section (this is pushed into as part of the build step)

image::/img/blog/azure-deploy3.png[Azure devops deployment pipeline setup stage 4 diagram,width=50%,align="center"]  
 
                      * Add a task to the Agent job by clicking on the '+' button on 'Agent job'

image::/img/blog/azure-deploy4.png[Azure devops deployment pipeline setup stage 5 diagram,width=50%,align="center"]

                      * Search for the task 'kubectl' and click 'Add'
                      * Configure the 'kubectl' task, select the 'apply' from the 'command' dropdown and select deployment configuration file from 'drop' folder and save it

image::/img/blog/azure-deploy5.png[Azure devops deployment pipeline setup stage 6 diagram,width=70%,align="center"]

                      * Enable the automatic deployment which will be trigger after the associated build is successfully completed

image::/img/blog/azure-deploy7.png[Azure devops deployment pipeline setup stage 7 diagram,width=70%,align="center"] 

Azure DevOps build and deployment pipeline are completed, now proceed to test the pipeline

== Running the build and deployment task.

           * Go to "Pipelines -> Pipelines" and select your build pipeline and click on "Run pipeline"  

image::/img/blog/azure-deploy8.png[Azure devops deployment pipeline run stage 1 diagram,width=60%,align="center"] 

           * When the build status is 'success', a deployment will be automatically created and executed.

image::/img/blog/azure-deploy9.png[Azure devops deployment pipeline run stage 2 diagram,width=60%,align="center"]  

           * Connect to Azure kubernetes cluster and verify the deployment status

image::/img/blog/azure-deploy11.jpeg[AKS connect details page,width=90%,align="center"]  

== Conclusion

You can configure your DevOps pipeline in many ways. This blog post is a quick introduction to how you can setup a simple Azure DevOPs pipeline to deploy your cloud-native Java applications on Liberty.
