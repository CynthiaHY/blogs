---
layout: post
title: "Continuous integration and delivery (CI/CD) of cloud-native Java applications using Azure DevOps service"
categories: blog
author_picture: https://avatars3.githubusercontent.com/shamjithantholi
author_github: https://github.com/shamjithantholi
seo-title: Continuous integration and delivery (CI/CD) of cloud-native Java applications using Azure DevOps service - OpenLiberty.io
seo-description: How to build a DevOps pipeline for a cloud-native Java application with tools available exclusively on Azure platform.
blog_description: How to build a DevOps pipeline for a cloud-native Java application with tools available exclusively on Azure platform.
open-graph-image: https://openliberty.io/img/blog/liberty-devops-generic-architecture.png
---
= Continuous integration and delivery (CI/CD) of cloud-native Java applications using Azure DevOps
Shamjith Antholi <https://github.com/shamjithantholi>
:imagesdir: /
:url-prefix:
:url-about: /

[#Intro]

Continuous integration and continuous deployment (CI/CD) is a process in which developers frequently merge code changes into a source code repository, which then triggers code builds, runs security scans, runs tests, and then deploys the application. Automation of this process, through adopting a DevOps culture, tools, and processes, enables organizations to release on a more frequent basis without compromising on quality. Various tools are available to automate the CI/CD process that can be readily integrated into a DevOps deployment pipeline. In this blog post, we'll discuss how you can use link:https://dev.azure.com[Azure DevOps] to automate the CI/CD process for building, testing, and deploying your cloud-native Java applications that run on link:https://openliberty.io[Open Liberty]. As the CI/CD process is triggered by source changes in Git, this is also known as the GitOps approach to DevOps.

Azure DevOps service is an SaaS/on-premise offering from microsoft using which we can create the complete DevOps pipeline excluively with Azure based tools. The following diagram shows a simple architecture for a Azure DevOps build and deployment pipeline that builds and deploys a Jakarta EE and MicroProfile application in Azure Kubernetes cluster environment. When a code change is made in the link:https://azure.microsoft.com/en-us/services/devops/repos/[Azure Git repository], Azure Git will trigger link:https://azure.microsoft.com/en-us/services/devops/pipelines/[Azure build pipeline], Scans the application dependencies using link:https://snyk.io[Snyk plugin] and generates a link:https://www.docker.com[Docker] container image of the application with Open Liberty as its runtime, saves the image to a link:https://azure.microsoft.com/en-us/services/container-registry/[Azure container registry], finally, link:https://azure.microsoft.com/en-us/services/devops/pipelines/[Azure release pipeline] will automatically trigger the deployment to link:https://azure.microsoft.com/en-us/services/kubernetes-service/#overview[Azure kubernetes services].

image::/img/blog/aks-deployment-pipeline.png[Azure devops deployment pipeline architecture diagram,width=90%,align="center"]

In this blog post, I will assume that you have a basic understanding of Git, Docker, and Kubernetes.

== Provisioning and configuring Microsoft Azure resources and Snyk to set up CI/CD of a cloud-native Java application

*Azure Account creation:* Login to link:https://portal.azure.com[Microsoft Azure] and subscribe to "Pay as you go with Azure". 

*Azure resource group:* Go to home page of link:https://portal.azure.com[Microsoft Azure] and click on "Create a resource" button. Search for "resource group" and create a resource group following the instructions. Resource group are a common identifier for all the related resources created in an Azure account. Resource groups are helpful for the resources that share the same lifecycle to easily deploy, update, and delete them as a group. 

*Azure container registry:* Go to home page of link:https://portal.azure.com[Microsoft Azure] and click on "Create a resource" button. Search for "container registry" and create a container registry following the instructions. Bind this container registry with the previously created 'resource group' selecting the same on the creation steps. 

*Azure kubernetes service:* Go to home page of link:https://portal.azure.com[Microsoft Azure] and click on "Create a resource" button. Search for "kubernetes service" and create the cluster following the instructions. Detailed cluster provisioning steps are available in link:https://docs.microsoft.com/en-us/azure/aks/learn/quick-kubernetes-deploy-portal?tabs=azure-cli[Quick start guide]. Bind this kubernetes cluster with the previously created 'resource group' selecting the same on the creation steps. 

*Azure DevOps:* Go to link:https://dev.azure.com/[Azure DevOps] and create an Azure DevOps organization using an existing Git account or using a microsoft account. Create a new project under this newly created organization. 

*Snyk account:* Go to link:https://app.snyk.io/[Synk] and create an account using an existing github account.

*Install Sync plugin in Azure Devops:* Login to https://dev.azure.com/<your-org> and click on "Organization settings". Click on "Extensions" on "General" section. Click on "browse marketplace" button. From the link:https://marketplace.visualstudio.com/azuredevops?utm_source=vstsproduct&utm_medium=L1BrowseMarketplace&targetId=5147ea18-72ed-4b60-bf15-5eda7c6b7a49[Azure marketplace] page, search for "Snyk" and install the same on your Azure devops organization following the instructions. 

*Service connections:* We need to create 3 service connections for using in Azure DevOps pipeline

                      1. **Container Registry:** Go to https://dev.azure.com/<your-org/ and select your Azure DevOps project. Click on the   
                         "Project settings" and click on "Service connections" under the section "Pipelines". Click on "New service connection" and search for "registry", select "Docker Registry" from the search results and click "Next" button. Select "Azure Container Registry" from the options and follow the further steps to create the service connection. +
                      2. **Azure Kubernetes service** Go to https://dev.azure.com/<your-org/ and select your Azure DevOps project. Click on the   
                         "Project settings" and click on "Service connections" under the section "Pipelines". Click on "New service connection" and search for "kubernetes", select "Kubernetes" from the search results and click "Next" button. Select "Azure Subscription" from the "Authentication method" and follow the further steps to create the service connection. + 
                      3. **Snyk** Go to https://dev.azure.com/<your-org/ and select your Azure DevOps project. Click on the   
                         "Project settings" and click on "Service connections" under the section "Pipelines". Click on "New service connection" and search for "snyk", select "Snyk Authentication" and follow the further steps to create the service connection. Steps to generate API token from snyk portal is explained in this service connection setup page.     

== Azure DevOps contineous integration pipeline setup steps

*Azure Git repository and Open Liberty code setup* Go to to https://dev.azure.com/<your-organisation>/_git/<your-project> and click on "Repos" and create a new git repository, follow the further steps to create the repository (repository checkout/check-in steps are provided in this "Repos" page, if you are doing it using HTTPS, click on "Genarate Git Credentials" to generate the credentials, for SSH checkout, click on "SSH --> Manage SSH Keys" and generate new keys). +
Check-in to the Azure git the Open Liberty code generated by the link:https://openliberty.io/start/[Liberty Starter] or by following the pattern described in link:https://github.com/OpenLiberty/ci.docker[Open Liberty Images]. The link:https://openliberty.io/guides/containerize.html[Containerize guide] is a helpful resource that goes into more details on how to create a container image for applications running on Liberty. Add the kubernetes deployment configuration file to this same repository

*Azure build pipeline setup* Go to https://dev.azure.com/<your-organisation>/_git/<your-project> page and follow these steps to create a pipeline. 

              * Click on "Pipelines" and then click on "Create Pipeline". 
              * Select "Azure Repos Git" and then select your repository from the next page. 
              * On "Configure your pipeline" page,select "Docker" (with description 'Build and push an image to Azure Container Registry') option. 
              * Select your azure subscription and click on "continue" button. Sign in to microsoft account on popup. 
              * Select container registry from the drop down, write the docker image name (which will be created and pushed to container registry by this build pipeline), make changes to default Dockerfile name (if any) and click on "Validate and configure" button. 

At this stage a pipeline yaml will be generated which you should configure according to your needs, make the follow changes 

              * Modify the git trigger branch, if any 

                          trigger: 
                            - main 

              * Under "variables" section in the yaml, change the image repository name to "liberty-app" ( or anything of your choice) and tag 
                 name to "latest" (or anything of your choice) 

                           imageRepository: 'liberty-app' 
                           tag: 'latest'              

              * Add maven build command (mvn package) as the first step in the build stage 

                            stages:
                            - stage: Build
                              displayName: Build and push stage
                              jobs:
                              - job: Build
                                displayName: Build
                                pool:
                                  vmImage: $(vmImageName)
                                steps:
                                - script: mvn package

              * Add "Snyk" details after the build step to scan all the dependency jar files used in this application. Keep the cursor above "mvn package" step and search for Snyk on the "Task" section on the right side of the page. Select the API token and "Application" in "What do you want to test?" dropdown anc click "Add" button

image::/img/blog/add-snyk-scan-to-stage.png[Add snyk scan to stage,width=90%,align="center"]

              * When the "Docker" task is completed, docker image will be created based on the instructions on "Dockerfile" and uploaded to Azure container registry. 

              * The last task required on build pipeline is to copy the deployment config file to azure staging repository for accessing the same on azure deployment pipeline (like the file 'azure-aks.yaml' in the below given example code). A complete sample Azure build pipeline code is given below. Save this code and run the pipeline 

                                    trigger:
                                    - main
                                    resources:
                                    - repo: self
                                    variables:
                                      # Container registry service connection established during pipeline creation
                                      dockerRegistryServiceConnection: '********'
                                      imageRepository: 'liberty-app'
                                      containerRegistry: '<registry-name>.azurecr.io'
                                      dockerfilePath: '$(Build.SourcesDirectory)/Dockerfile'
                                      tag: 'latest'
                                      # Agent VM image name
                                      vmImageName: 'ubuntu-latest'
                                    stages:
                                    - stage: Build
                                      displayName: Build and push stage
                                      jobs:
                                      - job: Build
                                        displayName: Build
                                        pool:
                                          vmImage: $(vmImageName)
                                        steps:
                                        - script: mvn package
                                        - task: SnykSecurityScan@1
                                          inputs:
                                            serviceConnectionEndpoint: 'snyk'
                                            testType: 'app'
                                            monitorWhen: 'always'
                                            failOnIssues: true
                                        - task: Docker@2
                                          displayName: Build and push an image to container registry
                                          inputs:
                                            command: buildAndPush
                                            repository: $(imageRepository)
                                            dockerfile: $(dockerfilePath)
                                            containerRegistry: $(dockerRegistryServiceConnection)
                                            tags: |
                                              $(tag)
                                        - task: CopyFiles@2
                                          displayName: 'Copy Files to: $(build.artifactstagingdirectory)'
                                          inputs:
                                            Contents: 'azure-aks.yaml'
                                            TargetFolder: '$(build.artifactstagingdirectory)'      
                                        - task: PublishBuildArtifacts@1
                                          displayName: 'Publish Artifact: drop'

*Azure deployment pipeline setup* Go to https://dev.azure.com/<your-organisation>/_git/<your-project> page and follow these steps to create a pipeline. 
                      * Click on "Releases" under "Pipelines" section, click on "New pipeline", a "Select template" popup will be available

                      * Search for "Deploy to kubernetes cluster" in "Select tenmplate page" and select the same. Give a name to the stage and close the same.

                      * Click on "1 job, 1 task" link on the deployment stage
                 
                 image::/img/blog/azure-deploy1.png[Azure devops deployment pipeline setup stage 1 diagram,width=90%,align="center"]

== Building the cloud-native Java application with Open Liberty on Jenkins

[source]
----
mvn package verify sonar:sonar -Dsonar.projectKey=sampleapp -Dsonar.host.url=http://localhost:9000 -Dsonar.login=<generated-login-key>
----

== Deploying cloud-native Java applications with Open Liberty to Kubernetes with Jenkins

For simplicity, I will use the command line (CLI) code in a Jenkins pipeline job to deploy a Jakarta EE and MicroProfile application with Open Liberty into Kubernetes. You can also use other tools like Helm, Travis CI, and CircleCI.

In your pipeline code, add these CLI commands in a new stage. The following sample pipeline code connects to IBM Cloud from the CLI and then connects to the Kubernetes cluster running inside that, then it runs all the Kubernetes deployment-related configurations.
                           
[source]
----
ibmcloud login --apikey $IBM_CLOUD_API_KEY -g $IBM_CLOUD_RSGRP
ibmcloud ks cluster config --cluster $CLUSTER-ID
kubectl config current-context
kubectl create -f deploy/deployment.yaml #( simple k8s deployment command )
kubectl create -f deploy/service.yaml #( simple k8s service creation command )
kubectl create -f deploy/route.yaml #( simple k8s route creation command )
----

Make sure that your Kubernetes configuration files are stored in the same Git repository as your Jenkinsfile in a sub-directory called `deploy`. Also ensure that the Docker image name in the Kubernetes deployment configuration file is updated according to the container image name/tag in the Dockerfile (manually, or programmatically if it needs to change at run time):

[.imageblock.img_border_light]
image::/img/blog/deploymentyaml.png[Image reference in deployment yaml,width=40%,align="center"]

When Jenkins has checked out the Java application code for the code build, all the Kubernetes configuration files are also downloaded to the Jenkins workspace so that Jenkins can run the IBM Cloud and Kubernetes commands to connect to the Kubernetes cluster and deploy the application.

See the link:https://kubernetes.io/docs/reference/kubectl/cheatsheet/[Kubernetes documentation] for other commands.

== QA testing cloud-native Java applications with Jenkins

Apart from running JUnit test cases along with the code build phase, Jenkins can trigger functional and integration QA test cases automatically after deploying the cloud-native Java application.

Configure the test cases in the Jenkins job and test it manually. Create a remote job identifier authentication token in the "Trigger builds remotely" section under "Build Triggers". Trigger this test case from the Docker "entrypoint" file by using a remote rest API call that uses this authentication token as the identifier.

For example, run the following command in a terminal: 

[source]
----
curl -I -u <auth-token> https://<jenkins-host>/job/<job-name>/build?token=<remote-job-identifier-authentication-token>
----

You can generate an authentication token (auth-token) with link:https://www.postman.com[Postman] using the Jenkins login credentials.

== Kubernetes monitoring tools

You can use the following Kubernetes commands to check the application or cluster logs and the memory and CPU usage: 

[source]
----
kubectl logs ..
cat /sys/fs/cgroup/cpu/cpuacct.usage (after connecting to k8s pod)
cat /sys/fs/cgroup/memory/memory.usage_in_bytes (after connecting to k8s pod)
----

You can integrate different applications with Kubernetes to persist logs and usage statistics, such as link:https://prometheus.io[Prometheus] and link:https://grafana.com/oss/loki/[Grafana].

Liberty makes it easy to collect and visualize system and application metrics for observability by using Prometheus and Grafana. You can find guidance and more details in the resources listed link:https://community.ibm.com/community/user/wasdevops/blogs/don-bourne1/2021/06/26/metrics-and-monitoring-guidance-for-open-liberty-a[here].


== Conclusion

You can configure your DevOps pipeline in many ways. This blog post is a quick introduction to how you can use Jenkins to set up a simple CI/CD pipeline to build and deploy your cloud-native Java applications on Liberty.
